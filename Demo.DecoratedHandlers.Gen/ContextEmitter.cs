using System.Collections.Generic;
using System.Text;
using Microsoft.CodeAnalysis.Text;

namespace Demo.DecoratedHandlers.Gen;

public class ContextEmitter
{
    public static SourceText CreateText(IReadOnlyList<PipelineDescription> pipelines)
    {
        var sb = new StringBuilder(256);

        sb.AppendLine(
$$"""
using System;
using Microsoft.Extensions.DependencyInjection;
using Demo.DecoratedHandlers.Abstractions;

// <auto-generated
namespace {{TextEmitter.NamespacePrefix}};

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("{{TextEmitter.EmitterAssemblyName.Name}}", "{{TextEmitter.EmitterAssemblyName.Version}}")]
[global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Always)]

public class PipelineContext : IPipelineContext
{
    public void Apply(IServiceCollection services)
    {
""");

        for (int i = 0; i < pipelines.Count; i++)
        {
            var pipeline = pipelines[i];
            var handler = pipeline.HandlerDescription;

            sb.AppendLine(
$$"""
          services.ReplaceWithPipeline<
              IRequestHandler<
                  {{handler.InputFullName}},
                  {{handler.OutputFullName}}>,
              {{handler.FullName}},
              {{pipeline.FullName}}>();
  """);

            if (i < pipelines.Count - 1)
            {
                sb.AppendLine();
            }
        }

        sb.AppendLine(
"""
    }
}
""");

        return SourceText.From(sb.ToString(), Encoding.UTF8);
    }
}